-- 1. Create Tables

-- Original Roll Call Table
CREATE TABLE O_RollCall (
    RollNo NUMBER PRIMARY KEY,
    Name VARCHAR2(50),
    DateOfCall DATE
);

-- New Roll Call Table
CREATE TABLE N_RollCall (
    RollNo NUMBER PRIMARY KEY,
    Name VARCHAR2(50),
    DateOfCall DATE
);

-- 2. Insert Sample Data

-- Data already in O_RollCall
INSERT INTO O_RollCall VALUES (1, 'Riya', TO_DATE('2025-11-01','YYYY-MM-DD'));
INSERT INTO O_RollCall VALUES (2, 'Raj', TO_DATE('2025-11-02','YYYY-MM-DD'));

-- Data in N_RollCall to merge
INSERT INTO N_RollCall VALUES (2, 'Raj', TO_DATE('2025-11-02','YYYY-MM-DD')); -- Duplicate
INSERT INTO N_RollCall VALUES (3, 'Priya', TO_DATE('2025-11-03','YYYY-MM-DD')); -- New
INSERT INTO N_RollCall VALUES (4, 'Dev', TO_DATE('2025-11-04','YYYY-MM-DD')); -- New

COMMIT;

-- 3. PL/SQL Block to Merge Data Using Cursor

SET SERVEROUTPUT ON; -- Enable DBMS_OUTPUT

DECLARE
    CURSOR c_new_roll IS
        SELECT * FROM N_RollCall;
    v_new_rec c_new_roll%ROWTYPE;
    v_count NUMBER;
BEGIN
    OPEN c_new_roll;
    LOOP
        FETCH c_new_roll INTO v_new_rec;
        EXIT WHEN c_new_roll%NOTFOUND;

        -- Check if record already exists
        SELECT COUNT(*) INTO v_count
        FROM O_RollCall
        WHERE RollNo = v_new_rec.RollNo;

        IF v_count = 0 THEN
            -- Insert new record
            INSERT INTO O_RollCall (RollNo, Name, DateOfCall)
            VALUES (v_new_rec.RollNo, v_new_rec.Name, v_new_rec.DateOfCall);

            DBMS_OUTPUT.PUT_LINE('Inserted RollNo: ' || v_new_rec.RollNo);
        ELSE
            DBMS_OUTPUT.PUT_LINE('Skipped RollNo (already exists): ' || v_new_rec.RollNo);
        END IF;
    END LOOP;

    CLOSE c_new_roll;
    COMMIT;

    DBMS_OUTPUT.PUT_LINE('Merge completed successfully.');
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;
/
-- 4. Check the Result

SELECT * FROM O_RollCall ORDER BY RollNo;
